name: Check Skills

on:
  pull_request:
    branches: [main]

jobs:
  drift-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check release-please config covers all skills
        run: |
          actual=$(find homelab/skills pr-review/skills -name SKILL.md -exec dirname {} \; 2>/dev/null | sort)
          configured=$(jq -r '.packages | keys[] | select(. != "." and (. | test("/skills/")))' release-please-config.json | sort)
          if ! diff <(echo "$actual") <(echo "$configured"); then
            echo "::error::Skill directories and release-please-config.json are out of sync"
            exit 1
          fi

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install rumdl
        run: |
          tag=$(gh release view --repo rvben/rumdl --json tagName -q .tagName)
          gh release download "$tag" --repo rvben/rumdl \
            --pattern "rumdl-${tag}-x86_64-unknown-linux-gnu.tar.gz" --output - \
            | tar xz -C /usr/local/bin rumdl
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Lint markdown
        run: |
          rumdl check homelab/skills/*/SKILL.md
          rumdl check pr-review/skills/*/SKILL.md 2>/dev/null || true
          rumdl check pr-review/agents/*.md 2>/dev/null || true
